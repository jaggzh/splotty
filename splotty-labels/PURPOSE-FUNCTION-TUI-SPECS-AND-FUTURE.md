# Purpose, Function, TUI Specs, and Future

## Purpose

`splotty-labels` is the **label and group manager** for the `splotty` serial plotter ecosystem. Its goal is to make complex field management (sensor raw values, filtered/EMA values, ranges, derived quantities, etc.) easy to capture, organize, and toggle. Rather than hard-coding labels in firmware or managing them manually, this tool provides a **terminal-based interactive manager** with persistence.

Key objectives:

* Automatically gather field labels from MCU serial output.
* Organize fields into a hierarchical tree of groups and subgroups.
* Provide fine-grained toggling and grouping for the plotter.
* Maintain presets for different devices, sessions, or experiments.
* Support keyboard *and* mouse-driven interaction in the terminal.

---

## Function

### Core responsibilities

1. **Preset management**

   * Load/create presets by name (`-p presetname`).
   * Save tree/group structure, field registry, last preview, and device info.
   * List presets (`-l/--list-presets`).

2. **Label capture (Monitor)**

   * Connect to serial device for N seconds (default 3).
   * Gather a few lines of output.
   * Identify label line(s): tokens containing `key:` (e.g., `s1raw:`).
   * Identify data-only line(s): numeric or unlabeled tokens.
   * If any field has a label, it is retained. Auto-indexed placeholders are used only until real labels are received.
   * If no labels at all: preview shows autogenerated `#0 #1 ...` until monitor provides one (or timeout is reached).

3. **Tree building (Groups/Fields)**

   * Left pane tree view.
   * Branches are group nodes; leaves are fields only (non-expandable).
   * User can expand/collapse levels or full subtrees.
   * Operations: Add Child/Sibling, Rename, Delete subtree, Move (reorder), Reparent (change parent).
   * Hotkeys are modeled after Vim-style navigation.

4. **Field list management**

   * Right pane list of all known fields.
   * Insert into tree by pressing Enter or dragging with mouse.
   * Selecting a field highlights all occurrences in the tree. If selected field is also focused in the tree, it uses a unique color.

5. **Header and device control**

   * Header shows preset name, Save, Quit, device string, baud, parity, stopbits.
   * Device selection (Alt-d) opens an interactive list of detected serial devices in the Dynamic Pane. Navigation with Up/Down, Enter to confirm, Esc to cancel.

6. **Dynamic Pane (messages/status/entry)**

   * Shows confirmations (Quit? Delete subtree?).
   * Used for device selection UI.
   * Displays operation status (e.g., Monitoring countdown, Saved preset).
   * Interactive mode blocks keys until resolved with y/N/Esc.

7. **Help Line**

   * Contextual help depending on focused pane.
   * Wraps if too long, resizes with terminal.

8. **Serial Preview**

   * Shows last captured preview (label + data lines).
   * Only appears after first successful monitor.
   * Persists with preset.
   * Wrapping enabled, scrollable when long.

---

## TUI Specs (based on user-provided design)

### Layout

```
Header area (preset name, Save, Quit, Device info)
--------------------------------
Group Tree | Current Fields List
--------------------------------
Serial preview (wraps)
--------------------------------
Dynamic content: {Messages/status|Text entry} (wraps)
--------------------------------
Help line - context-sensitive (wraps)
```

* **Header**: 1 line fixed.
* **Main split**: flex-height tree (left) + fields (right).
* **Serial preview**: min 1 line, max \~8 (configurable).
* **Dynamic content**: min 1 line, max \~3.
* **Help line**: min 1 line, max \~2.
* Resizing logic: bottom panes expand minimally, main split gets rest.

### Tree view

* Icons:

  * `⇊` Expand full tree
  * `↴` Expand one level
  * `⇖` Collapse tree
  * `↖` Collapse one level
  * `f` Field (leaf)
* Navigation:

  * `j`/`k` move down/up visible items.
  * `l` expand one level.
  * `L` expand subtree.
  * `h` collapse one level.
  * `H` collapse subtree.
* Editing:

  * `a` add child branch.
  * `o` add sibling branch.
  * `Enter` edit branch name.
  * `-` delete subtree (confirmation required).
  * `M` monitor serial.
* Movement:

  * `J`/`K` relocate child up/down.
  * `Alt-j`/`Alt-k` reparent to next/prev branch (skips leaves).

### Field list

* Navigation: `h`/`j` move up/down.
* `Enter`: insert field under current tree selection (as child or sibling depending on context).
* Mouse drag: drop onto tree to insert.
* Highlight: selected field highlights all tree appearances.

### Serial preview (monitor logic)

* Monitor runs for N seconds.
* Detects label lines (`key:` tokens).
* Detects data-only lines (no colons).
* If labels present: show captured label line + captured data line.
* If no labels: auto-generate `#0 #1 #2 ...` line for preview only, do not add to registry.
* Registry only updated with actual labels from monitor.

### Device selection

* Alt-d opens interactive selector in Dynamic Pane.
* Lists detected devices or defaults.
* Up/Down arrows cycle, Enter sets, Esc cancels.
* q inside device mode aborts and forwards to quit.
* Upon setting: header updates device name, preset updated.

### Quit & Delete confirmations

* Quit (q) shows `Quit? (y/N)` in Dynamic Pane.
* Delete subtree shows `Delete subtree 'X' (N nodes)? (y/N)`.
* Confirm with `y`; cancel with `n` or Esc.

---

## Data Gathering Details

* **Monitor** uses `--monitor-secs` (CLI or default 3s).
* Captures serial lines until timeout.
* **Label retention rule**: if any column is labeled, retain its label for all future sessions until explicitly changed. MCU can periodically re-emit header lines.
* **Partial label lines**: if some fields have labels and others don’t, unlabeled fields keep their previous label (or remain indexed until a label appears).
* **No placeholder persistence**: placeholders (`#0`, `#1`) are preview-only, not saved.
* **Last preview**: saved in preset and shown on startup.

---

## Future

### Near-term

* Full inline rename for branches.
* Visual markers for reparent operations.
* Scrollable/filtered field list.
* Persistent pane sizing.

### Mid-term

* Toggle field/group visibility directly from tree.
* Live monitor mode for continuous preview.
* Configurable hotkeys.
* More robust serial discovery with hotplug.

### Long-term

* Integration with `splotty-plotter`: control visible groups directly.
* Plugins for transforms (unit conversions, scaling, filters) attached in tree.
* Networking backends (TCP/UDP/WS) for non-serial sources.
* Alternative front-ends (e.g., web) using same presets.

---

This document now captures **all user-provided specifications**: tree behaviors, field list interactions, header/device handling, data-line gathering rules, preview persistence, and future directions.
